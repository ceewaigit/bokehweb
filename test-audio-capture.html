<!DOCTYPE html>
<html>
<head>
    <title>Audio Capture Test</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto;
        }
        button { 
            margin: 10px; 
            padding: 10px 20px; 
            font-size: 16px;
        }
        .log { 
            background: #f0f0f0; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
        video { 
            width: 100%; 
            max-width: 600px; 
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>WebM Audio Capture Test</h1>
    
    <div>
        <button onclick="startTest()">Start Recording Test</button>
        <button onclick="stopTest()" disabled id="stopBtn">Stop Recording</button>
    </div>
    
    <div id="logs"></div>
    
    <video id="preview" controls style="display:none"></video>
    
    <script>
        let mediaRecorder = null;
        let chunks = [];
        let stream = null;
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logEntry);
            console.log(message);
        }
        
        async function startTest() {
            try {
                chunks = [];
                
                // Test different audio constraints
                log('Requesting microphone access...', 'info');
                
                const audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: false
                });
                
                const audioTracks = audioStream.getAudioTracks();
                log(`Got ${audioTracks.length} audio track(s)`, 'success');
                
                if (audioTracks.length > 0) {
                    const track = audioTracks[0];
                    log(`Audio track: ${track.label}, enabled: ${track.enabled}, muted: ${track.muted}`, 'info');
                }
                
                // Now get video
                log('Getting screen capture...', 'info');
                const videoStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: false
                });
                
                // Combine streams
                stream = new MediaStream();
                videoStream.getVideoTracks().forEach(track => stream.addTrack(track));
                audioStream.getAudioTracks().forEach(track => stream.addTrack(track));
                
                log(`Combined stream - Video: ${stream.getVideoTracks().length}, Audio: ${stream.getAudioTracks().length}`, 'success');
                
                // Test different mime types
                const mimeTypes = [
                    'video/webm;codecs=vp8,opus',
                    'video/webm;codecs=vp9,opus',
                    'video/webm;codecs=vp8',
                    'video/webm'
                ];
                
                let selectedMimeType = 'video/webm';
                for (const mimeType of mimeTypes) {
                    if (MediaRecorder.isTypeSupported(mimeType)) {
                        selectedMimeType = mimeType;
                        log(`Using mimeType: ${mimeType}`, 'success');
                        break;
                    }
                }
                
                // Create MediaRecorder
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: selectedMimeType,
                    videoBitsPerSecond: 5000000,
                    audioBitsPerSecond: 128000
                });
                
                log(`MediaRecorder created - actual mimeType: ${mediaRecorder.mimeType}`, 'info');
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) {
                        chunks.push(event.data);
                        log(`Data chunk received: ${event.data.size} bytes, type: ${event.data.type}`, 'info');
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: selectedMimeType });
                    log(`Recording complete - ${chunks.length} chunks, total: ${blob.size} bytes`, 'success');
                    
                    // Create URL and test playback
                    const url = URL.createObjectURL(blob);
                    const video = document.getElementById('preview');
                    video.src = url;
                    video.style.display = 'block';
                    
                    // Check if video has audio
                    video.onloadedmetadata = () => {
                        log(`Video loaded - Duration: ${video.duration}s`, 'info');
                        log(`Video muted: ${video.muted}, volume: ${video.volume}`, 'info');
                        
                        // Try to detect audio
                        const audioContext = new AudioContext();
                        fetch(url)
                            .then(response => response.arrayBuffer())
                            .then(buffer => audioContext.decodeAudioData(buffer))
                            .then(audioBuffer => {
                                log(`✅ Audio detected - channels: ${audioBuffer.numberOfChannels}, duration: ${audioBuffer.duration}s`, 'success');
                            })
                            .catch(err => {
                                log(`❌ No audio track found: ${err.message}`, 'error');
                            });
                    };
                };
                
                mediaRecorder.start(1000); // Get data every second
                log('Recording started!', 'success');
                
                document.getElementById('stopBtn').disabled = false;
                document.querySelector('button').disabled = true;
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        function stopTest() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                stream.getTracks().forEach(track => track.stop());
                
                document.getElementById('stopBtn').disabled = true;
                document.querySelector('button').disabled = false;
            }
        }
    </script>
</body>
</html>